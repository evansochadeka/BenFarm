{% extends "components/base.html" %}

{% block title %}Community Chat - Adiseware{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 600px;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #1e3c2c 0%, #2d5a3b 100%);
        color: white;
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: white;
    }
    
    .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #dee2e6;
    }
    
    .message {
        display: flex;
        margin-bottom: 20px;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
    }
    
    .message-content {
        flex: 1;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        background: #f1f3f5;
        position: relative;
    }
    
    .message.own-message {
        flex-direction: row-reverse;
    }
    
    .message.own-message .message-avatar {
        margin-right: 0;
        margin-left: 12px;
    }
    
    .message.own-message .message-bubble {
        background: #28a745;
        color: white;
    }
    
    .message-meta {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .message-author {
        font-weight: 600;
        margin-right: 8px;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .own-message .message-time {
        color: rgba(255,255,255,0.8);
    }
    
    .typing-indicator {
        display: flex;
        padding: 12px 16px;
        background: #f1f3f5;
        border-radius: 18px;
        width: fit-content;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: #6c757d;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    
    .online-indicator {
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.2); }
        100% { opacity: 1; transform: scale(1); }
    }
    
    .chat-sidebar {
        background: white;
        border-radius: 15px;
        padding: 20px;
        height: calc(100vh - 200px);
        min-height: 600px;
        overflow-y: auto;
    }
    
    .user-list-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .user-list-item:hover {
        background: #f8f9fa;
    }
    
    .user-list-item.active {
        background: #e8f5e9;
        border-left: 4px solid #28a745;
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
    }
    
    .user-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
    }
    
    .status-online { background: #28a745; }
    .status-away { background: #ffc107; }
    .status-offline { background: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Chat Main Area -->
    <div class="col-lg-8">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i> Community Chat
                        </h5>
                        <small class="text-white-50">
                            <span class="online-indicator"></span>
                            <span id="onlineCount">0</span> farmers online
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light" onclick="loadMessages('general')">
                            <i class="fas fa-globe me-1"></i> General
                        </button>
                        <button class="btn btn-sm btn-outline-light ms-2" onclick="loadMessages('farming')">
                            <i class="fas fa-leaf me-1"></i> Farming
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>Welcome to the community chat!<br><small>Say hello to other farmers ðŸ‘‹</small></p>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="chat-input-container">
                <form id="chatForm" onsubmit="sendMessage(event)">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-lg" 
                               id="messageInput" placeholder="Type your message..." 
                               autocomplete="off">
                        <button class="btn btn-success btn-lg" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Be respectful and helpful to fellow farmers
                    </small>
                    <small class="text-muted">
                        Press <kbd>Enter</kbd> to send
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Sidebar -->
    <div class="col-lg-4">
        <div class="chat-sidebar">
            <h6 class="mb-3">
                <i class="fas fa-users me-2"></i> Farmers Online
                <span class="badge bg-success rounded-pill ms-2" id="sidebarOnlineCount">0</span>
            </h6>
            
            <div id="onlineUsersList">
                <!-- Online users will be loaded here -->
            </div>
            
            <hr>
            
            <h6 class="mb-3">
                <i class="fas fa-clock me-2"></i> Recent Activity
            </h6>
            
            <div id="recentActivity">
                <!-- Recent activity will be loaded here -->
            </div>
            
            <hr>
            
            <div class="bg-light p-3 rounded">
                <h6 class="mb-2">Community Guidelines</h6>
                <ul class="small mb-0">
                    <li class="mb-1">âœ“ Be respectful and kind</li>
                    <li class="mb-1">âœ“ Share farming knowledge</li>
                    <li class="mb-1">âœ“ Ask questions freely</li>
                    <li class="mb-1">âœ“ No spam or promotions</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    let socket = io();
    let currentRoom = 'general';
    let typingTimer;
    
    // Join chat on load
    socket.on('connect', function() {
        socket.emit('join', {
            user_id: {{ current_user.id }},
            username: '{{ current_user.full_name }}',
            room: currentRoom
        });
    });
    
    // Receive message
    socket.on('message', function(data) {
        displayMessage(data);
    });
    
    // Update online users
    socket.on('users_online', function(users) {
        updateOnlineUsers(users);
    });
    
    // User typing indicator
    socket.on('typing', function(data) {
        showTypingIndicator(data);
    });
    
    // Load messages for room
    function loadMessages(room) {
        currentRoom = room;
        socket.emit('join_room', room);
        document.getElementById('chatMessages').innerHTML = '';
        
        fetch('/api/chat/messages?room=' + room)
            .then(response => response.json())
            .then(messages => {
                messages.forEach(displayMessage);
            });
    }
    
    // Send message
    function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (message) {
            socket.emit('send_message', {
                user_id: {{ current_user.id }},
                username: '{{ current_user.full_name }}',
                message: message,
                room: currentRoom,
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
        }
    }
    
    // Display message
    function displayMessage(data) {
        const messagesContainer = document.getElementById('chatMessages');
        const isOwnMessage = data.user_id === {{ current_user.id }};
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
        
        messageDiv.innerHTML = `
            <img src="${data.avatar || '/static/uploads/default_avatar.png'}" 
                 class="message-avatar" alt="${data.username}">
            <div class="message-content">
                <div class="message-meta">
                    <span class="message-author">${data.username}</span>
                    <span class="message-time">${formatTime(data.timestamp)}</span>
                </div>
                <div class="message-bubble">
                    ${escapeHtml(data.message)}
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Typing indicator
    function showTypingIndicator(data) {
        // Remove existing typing indicator
        const existing = document.getElementById('typingIndicator');
        if (existing) existing.remove();
        
        if (data.isTyping) {
            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'message';
            indicator.innerHTML = `
                <img src="${data.avatar || '/static/uploads/default_avatar.png'}" 
                     class="message-avatar" alt="${data.username}">
                <div class="message-content">
                    <div class="typing-indicator">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            `;
            document.getElementById('chatMessages').appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    // Input typing handler
    document.getElementById('messageInput').addEventListener('input', function() {
        clearTimeout(typingTimer);
        socket.emit('typing', {
            user_id: {{ current_user.id }},
            username: '{{ current_user.full_name }}',
            room: currentRoom,
            isTyping: true
        });
        
        typingTimer = setTimeout(function() {
            socket.emit('typing', {
                user_id: {{ current_user.id }},
                username: '{{ current_user.full_name }}',
                room: currentRoom,
                isTyping: false
            });
        }, 1000);
    });
    
    // Helper functions
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    function updateOnlineUsers(users) {
        const onlineCount = users.length;
        document.getElementById('onlineCount').textContent = onlineCount;
        document.getElementById('sidebarOnlineCount').textContent = onlineCount;
        
        let html = '';
        users.forEach(user => {
            html += `
                <div class="user-list-item">
                    <img src="${user.avatar || '/static/uploads/default_avatar.png'}" 
                         class="user-avatar" alt="${user.username}">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <strong>${user.username}</strong>
                            <span class="user-status status-online"></span>
                        </div>
                        <small class="text-muted">${user.user_type || 'Farmer'}</small>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('onlineUsersList').innerHTML = html || '<p class="text-muted text-center">No users online</p>';
    }
</script>
{% endblock %}